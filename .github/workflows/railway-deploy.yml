name: Railway Deploy

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/railway-deploy.yml'
      - 'my-page-api/**'
      - 'my-page-app/**'
  workflow_dispatch:
    inputs:
      deploy_api:
        description: 'Deploy API'
        type: boolean
        default: true
      deploy_app:
        description: 'Deploy App'
        type: boolean
        default: true

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  # Build and test API
  build-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'liberica'
          java-version: '21'
          cache: 'maven'

      - name: Build API
        run: ./mvnw -pl my-page-api -e -am package -DskipTests

      - name: Run tests
        run: ./mvnw -pl my-page-api test
        continue-on-error: true  # Don't fail on test errors for now

  # Build and test App
  build-app:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: my-page-app
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: my-page-app/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate OpenAPI types
        run: npm run build:openapi

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

  # Deploy API to Railway (test environment)
  deploy-api-test:
    needs: build-api
    runs-on: ubuntu-latest
    environment: railway-test
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy API to Railway
        working-directory: my-page-api
        run: railway up --service ${{ vars.RAILWAY_API_SERVICE_NAME || 'my-page-api' }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_TEST }}
          RAILWAY_PROJECT_ID: ${{ vars.RAILWAY_PROJECT_ID_TEST }}

  # Deploy App to Railway (test environment)
  deploy-app-test:
    needs: build-app
    runs-on: ubuntu-latest
    environment: railway-test
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy App to Railway
        working-directory: my-page-app
        run: railway up --service ${{ vars.RAILWAY_APP_SERVICE_NAME || 'my-page-app' }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_TEST }}
          RAILWAY_PROJECT_ID: ${{ vars.RAILWAY_PROJECT_ID_TEST }}

  # Deploy to production (manual approval required via GitHub environment)
  deploy-api-prod:
    needs: deploy-api-test
    runs-on: ubuntu-latest
    environment: railway-prod
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy API to Railway Production
        working-directory: my-page-api
        run: railway up --service ${{ vars.RAILWAY_API_SERVICE_NAME || 'my-page-api' }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_PROD }}
          RAILWAY_PROJECT_ID: ${{ vars.RAILWAY_PROJECT_ID_PROD }}

  deploy-app-prod:
    needs: deploy-app-test
    runs-on: ubuntu-latest
    environment: railway-prod
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy App to Railway Production
        working-directory: my-page-app
        run: railway up --service ${{ vars.RAILWAY_APP_SERVICE_NAME || 'my-page-app' }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_PROD }}
          RAILWAY_PROJECT_ID: ${{ vars.RAILWAY_PROJECT_ID_PROD }}